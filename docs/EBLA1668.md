// Complete EnhancedBookLibraryApp.jsx with Fixed EnhancedBookCard Component
import React, { useState, useMemo, useCallback, useEffect } from 'react';
import { StartReadingButton } from '../components/ReadingSessionUI';

// Context and Hooks
import { useGamification } from '../contexts/GamificationContext';
import { useAuth } from '../contexts/AuthContext';
import { useSnackbar } from '../components/Material3';

// Components
import GamificationDashboard from './gamification/GamificationDashboard';
import EnhancedWelcomeComponent from './EnhancedWelcomeComponent';

// Material Design 3 Components
import {
  MD3Card,
  MD3Button,
  MD3TextField,
  MD3Chip,
  MD3ChipGroup,
  MD3Dialog,
  MD3DialogActions,
  MD3Switch,
  MD3Menu,
  MD3MenuItem,
  MD3MenuDivider,
  MD3SortMenu,
  MD3BookActionsMenu,
  MD3FloatingActionButton,
  MD3BookLibraryFab,
  MD3Progress,
  CircularProgress,
  useThemeColors
} from '../components/Material3';

// CSS
import './EnhancedBookLibraryApp.css';

// ===============================================
// FIXED ENHANCED BOOK CARD COMPONENT
// ===============================================
const EnhancedBookCard = ({ 
  book, 
  viewMode = 'grid', 
  onRead, 
  onStartReading, 
  onStopReading,
  onEdit,
  onDelete,
  onMenuAction,
  className = ''
}) => {
  const [showMenu, setShowMenu] = useState(false);

  const handleCardClick = (e) => {
    // Only trigger if not clicking on menu button or menu items
    if (e.target.closest('.menu-button') || e.target.closest('.book-menu')) {
      return;
    }
    
    console.log('üìñ Card clicked, opening book:', book.title);
    onRead?.(book);
  };

  const handleMenuClick = (e) => {
    e.stopPropagation(); // Prevent card click
    setShowMenu(!showMenu);
  };

  const handleMenuAction = (action) => {
    console.log(`üé¨ Menu action: ${action} for book:`, book.title);
    setShowMenu(false);
    
    switch (action) {
      case 'read':
        onRead?.(book);
        break;
      case 'start-reading':
        onStartReading?.(book);
        break;
      case 'stop-reading':
        onStopReading?.(book);
        break;
      case 'edit':
        onEdit?.(book);
        break;
      case 'delete':
        onDelete?.(book);
        break;
      default:
        onMenuAction?.(action, book);
    }
  };

  return (
    <div className={`enhanced-book-card ${viewMode} ${className}`}>
      {/* ‚úÖ FIXED: Main card area as DIV with click handler, not button */}
      <div 
        className="book-card-content"
        onClick={handleCardClick}
        style={{
          borderRadius: '12px',
          background: 'rgb(var(--md-sys-color-surface-container-low))',
          border: '1px solid rgb(var(--md-sys-color-outline-variant))',
          padding: '16px',
          cursor: 'pointer',
          transition: 'all 0.2s ease',
          position: 'relative'
        }}
        onMouseEnter={(e) => {
          e.currentTarget.style.boxShadow = 'var(--md-sys-elevation-level2)';
          e.currentTarget.style.transform = 'translateY(-2px)';
        }}
        onMouseLeave={(e) => {
          e.currentTarget.style.boxShadow = 'none';
          e.currentTarget.style.transform = 'translateY(0)';
        }}
      >
        {/* Book Cover */}
        <div className="book-cover" style={{ 
          marginBottom: '12px', 
          position: 'relative',
          borderRadius: '8px',
          overflow: 'hidden',
          aspectRatio: '3/4',
          backgroundColor: '#f0f0f0'
        }}>
          {book.cover_url ? (
            <img 
              src={book.cover_url} 
              alt={`${book.title} cover`}
              style={{
                width: '100%',
                height: '100%',
                objectFit: 'cover'
              }}
              onError={(e) => {
                e.target.style.display = 'none';
                if (e.target.nextSibling) {
                  e.target.nextSibling.style.display = 'flex';
                }
              }}
            />
          ) : null}
          
          {/* Fallback cover */}
          <div style={{
            display: book.cover_url ? 'none' : 'flex',
            width: '100%',
            height: '100%',
            alignItems: 'center',
            justifyContent: 'center',
            backgroundColor: '#e3f2fd',
            flexDirection: 'column',
            gap: '8px'
          }}>
            <span style={{ fontSize: '24px' }}>üìö</span>
            <span style={{ 
              fontSize: '10px', 
              textAlign: 'center', 
              padding: '0 4px',
              fontWeight: '500'
            }}>
              {book.title?.substring(0, 20)}
              {book.title?.length > 20 ? '...' : ''}
            </span>
          </div>

          {/* ‚úÖ FIXED: Menu button positioned absolutely, not nested in main button */}
          <button
            className="menu-button"
            onClick={handleMenuClick}
            aria-label="Book actions"
            style={{
              position: 'absolute',
              top: '8px',
              right: '8px',
              width: '32px',
              height: '32px',
              borderRadius: '50%',
              border: 'none',
              backgroundColor: 'rgba(0, 0, 0, 0.6)',
              color: 'white',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '16px',
              zIndex: 10
            }}
          >
            ‚ãÆ
          </button>

          {/* Reading status indicator */}
          {book.isReading && (
            <div style={{
              position: 'absolute',
              bottom: '8px',
              left: '8px',
              backgroundColor: '#4caf50',
              color: 'white',
              padding: '4px 8px',
              borderRadius: '12px',
              fontSize: '10px',
              fontWeight: '500'
            }}>
              Reading
            </div>
          )}
        </div>

        {/* Book Info */}
        <div className="book-info" style={{ textAlign: 'left' }}>
          <h3 style={{ 
            margin: '0 0 4px 0', 
            fontSize: '14px',
            fontWeight: '600',
            lineHeight: '1.2',
            color: 'rgb(var(--md-sys-color-on-surface))'
          }}>
            {book.title}
          </h3>
          {book.author && (
            <p style={{ 
              margin: '0 0 8px 0', 
              fontSize: '12px',
              color: 'rgb(var(--md-sys-color-on-surface-variant))'
            }}>
              {book.author}
            </p>
          )}
          
          {/* Progress bar if reading */}
          {book.isReading && book.progress !== undefined && (
            <div style={{
              marginTop: '8px',
              backgroundColor: 'rgb(var(--md-sys-color-surface-container-highest))',
              borderRadius: '4px',
              height: '4px',
              overflow: 'hidden'
            }}>
              <div style={{
                width: `${book.progress || 0}%`,
                height: '100%',
                backgroundColor: 'rgb(var(--md-sys-color-primary))',
                transition: 'width 0.3s ease'
              }} />
            </div>
          )}
        </div>
      </div>

      {/* Dropdown Menu */}
      {showMenu && (
        <div 
          className="book-menu"
          style={{
            position: 'absolute',
            top: '56px',
            right: '8px',
            backgroundColor: 'white',
            borderRadius: '8px',
            boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
            minWidth: '160px',
            zIndex: 100,
            overflow: 'hidden'
          }}
        >
          <button
            onClick={() => handleMenuAction('read')}
            style={{
              width: '100%',
              padding: '12px 16px',
              border: 'none',
              backgroundColor: 'transparent',
              textAlign: 'left',
              cursor: 'pointer',
              fontSize: '14px'
            }}
            onMouseEnter={(e) => e.target.style.backgroundColor = '#f5f5f5'}
            onMouseLeave={(e) => e.target.style.backgroundColor = 'transparent'}
          >
            üìñ Read
          </button>
          
          {book.isReading ? (
            <button
              onClick={() => handleMenuAction('stop-reading')}
              style={{
                width: '100%',
                padding: '12px 16px',
                border: 'none',
                backgroundColor: 'transparent',
                textAlign: 'left',
                cursor: 'pointer',
                fontSize: '14px'
              }}
              onMouseEnter={(e) => e.target.style.backgroundColor = '#f5f5f5'}
              onMouseLeave={(e) => e.target.style.backgroundColor = 'transparent'}
            >
              ‚èπÔ∏è Stop Reading
            </button>
          ) : (
            <button
              onClick={() => handleMenuAction('start-reading')}
              style={{
                width: '100%',
                padding: '12px 16px',
                border: 'none',
                backgroundColor: 'transparent',
                textAlign: 'left',
                cursor: 'pointer',
                fontSize: '14px'
              }}
              onMouseEnter={(e) => e.target.style.backgroundColor = '#f5f5f5'}
              onMouseLeave={(e) => e.target.style.backgroundColor = 'transparent'}
            >
              ‚ñ∂Ô∏è Start Reading
            </button>
          )}
          
          <hr style={{ margin: 0, border: 'none', borderTop: '1px solid #eee' }} />
          
          <button
            onClick={() => handleMenuAction('edit')}
            style={{
              width: '100%',
              padding: '12px 16px',
              border: 'none',
              backgroundColor: 'transparent',
              textAlign: 'left',
              cursor: 'pointer',
              fontSize: '14px'
            }}
            onMouseEnter={(e) => e.target.style.backgroundColor = '#f5f5f5'}
            onMouseLeave={(e) => e.target.style.backgroundColor = 'transparent'}
          >
            ‚úèÔ∏è Edit
          </button>
          
          <button
            onClick={() => handleMenuAction('delete')}
            style={{
              width: '100%',
              padding: '12px 16px',
              border: 'none',
              backgroundColor: 'transparent',
              textAlign: 'left',
              cursor: 'pointer',
              fontSize: '14px',
              color: '#d32f2f'
            }}
            onMouseEnter={(e) => e.target.style.backgroundColor = '#ffebee'}
            onMouseLeave={(e) => e.target.style.backgroundColor = 'transparent'}
          >
            üóëÔ∏è Delete
          </button>
        </div>
      )}

      {/* Click outside to close menu */}
      {showMenu && (
        <div
          style={{
            position: 'fixed',
            inset: 0,
            zIndex: 99
          }}
          onClick={() => setShowMenu(false)}
        />
      )}
    </div>
  );
};

// ===============================================
// SETTINGS DIALOG COMPONENT
// ===============================================
const SettingsDialog = ({ open, onClose }) => {
  const [settings, setSettings] = useState({
    darkMode: false,
    notifications: true,
    syncEnabled: true,
    autoBackup: true,
    readingReminders: false,
    dailyGoal: 30,
    privacyMode: false,
    compactView: false,
    autoFindCovers: true,
    readingStats: true
  });

  const handleSettingChange = (key, value) => {
    setSettings(prev => ({ ...prev, [key]: value }));
  };

  const handleSave = () => {
    // Save settings to localStorage or backend
    localStorage.setItem('appSettings', JSON.stringify(settings));
    onClose();
  };

  return (
    <MD3Dialog open={open} onClose={onClose} maxWidth="md">
      <div className="settings-dialog">
        <h2>Settings</h2>
        
        <div className="settings-section">
          <h3>Appearance</h3>
          <div className="setting-item">
            <label>
              <div>Dark Mode</div>
              <small>Use dark theme for better reading at night</small>
            </label>
            <MD3Switch 
              checked={settings.darkMode}
              onChange={(e) => handleSettingChange('darkMode', e.target.checked)}
            />
          </div>
          <div className="setting-item">
            <label>
              <div>Compact View</div>
              <small>Show more books on screen with smaller cards</small>
            </label>
            <MD3Switch 
              checked={settings.compactView}
              onChange={(e) => handleSettingChange('compactView', e.target.checked)}
            />
          </div>
        </div>

        <div className="settings-section">
          <h3>Notifications</h3>
          <div className="setting-item">
            <label>
              <div>Enable Notifications</div>
              <small>Get updates about your reading progress</small>
            </label>
            <MD3Switch 
              checked={settings.notifications}
              onChange={(e) => handleSettingChange('notifications', e.target.checked)}
            />
          </div>
          <div className="setting-item">
            <label>
              <div>Reading Reminders</div>
              <small>Daily reminders to meet your reading goals</small>
            </label>
            <MD3Switch 
              checked={settings.readingReminders}
              onChange={(e) => handleSettingChange('readingReminders', e.target.checked)}
            />
          </div>
        </div>

        <div className="settings-section">
          <h3>Data & Sync</h3>
          <div className="setting-item">
            <label>
              <div>Sync Library</div>
              <small>Keep your library synced across devices</small>
            </label>
            <MD3Switch 
              checked={settings.syncEnabled}
              onChange={(e) => handleSettingChange('syncEnabled', e.target.checked)}
            />
          </div>
          <div className="setting-item">
            <label>
              <div>Auto Backup</div>
              <small>Automatically backup your library data</small>
            </label>
            <MD3Switch 
              checked={settings.autoBackup}
              onChange={(e) => handleSettingChange('autoBackup', e.target.checked)}
            />
          </div>
          <div className="setting-item">
            <label>
              <div>Auto Find Covers</div>
              <small>Automatically search for book covers</small>
            </label>
            <MD3Switch 
              checked={settings.autoFindCovers}
              onChange={(e) => handleSettingChange('autoFindCovers', e.target.checked)}
            />
          </div>
        </div>

        <div className="settings-section">
          <h3>Reading Goals</h3>
          <div className="setting-item">
            <label>
              <div>Daily Goal (minutes)</div>
              <small>Set your daily reading target</small>
            </label>
            <MD3TextField 
              type="number"
              value={settings.dailyGoal}
              onChange={(e) => handleSettingChange('dailyGoal', parseInt(e.target.value))}
              min="5"
              max="240"
            />
          </div>
          <div className="setting-item">
            <label>
              <div>Track Reading Stats</div>
              <small>Monitor your reading speed and habits</small>
            </label>
            <MD3Switch 
              checked={settings.readingStats}
              onChange={(e) => handleSettingChange('readingStats', e.target.checked)}
            />
          </div>
        </div>

        <div className="settings-section">
          <h3>Privacy</h3>
          <div className="setting-item">
            <label>
              <div>Privacy Mode</div>
              <small>Hide sensitive information when sharing screen</small>
            </label>
            <MD3Switch 
              checked={settings.privacyMode}
              onChange={(e) => handleSettingChange('privacyMode', e.target.checked)}
            />
          </div>
        </div>

        <MD3DialogActions>
          <MD3Button onClick={onClose} variant="text">Cancel</MD3Button>
          <MD3Button onClick={handleSave} variant="filled">Save Changes</MD3Button>
        </MD3DialogActions>
      </div>
    </MD3Dialog>
  );
};

// ===============================================
// NAVIGATION HEADER COMPONENT
// ===============================================
const NavigationHeader = ({ 
  currentPage, 
  onNavigate, 
  onSearch, 
  onSettings, 
  onProfile,
  onNotifications,
  notifications = [],
  quickStats = {}
}) => {
  const [profileMenuOpen, setProfileMenuOpen] = useState(false);
  const [notificationsOpen, setNotificationsOpen] = useState(false);
  const [searchOpen, setSearchOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');

  const navItems = [
    { id: 'library', label: 'Library', icon: 'üìö' },
    { id: 'reading', label: 'Currently Reading', icon: 'üìñ' },
    { id: 'gamification', label: 'Achievements', icon: 'üèÜ' },
    { id: 'collections', label: 'Collections', icon: 'üìÅ' },
    { id: 'stats', label: 'Stats', icon: 'üìä' }
  ];

  const handleSearch = (e) => {
    e.preventDefault();
    onSearch?.(searchQuery);
    setSearchOpen(false);
  };

  return (
    <header className="nav-header">
      <div className="nav-container">
        {/* Logo */}
        <div className="nav-logo">
          <span className="logo-icon">üìö</span>
          <span className="logo-text">My Library</span>
        </div>

        {/* Navigation Tabs */}
        <nav className="nav-tabs">
          {navItems.map(item => (
            <button
              key={item.id}
              onClick={() => onNavigate(item.id)}
              className={`nav-tab ${currentPage === item.id ? 'active' : ''}`}
            >
              <span className="tab-icon">{item.icon}</span>
              <span className="tab-label">{item.label}</span>
            </button>
          ))}
        </nav>

        {/* Right Actions */}
        <div className="nav-actions">
          {/* Search */}
          {searchOpen ? (
            <form onSubmit={handleSearch} className="search-form">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search books..."
                autoFocus
              />
              <button type="submit">üîç</button>
              <button type="button" onClick={() => setSearchOpen(false)}>‚úï</button>
            </form>
          ) : (
            <button className="nav-action-btn" onClick={() => setSearchOpen(true)}>
              üîç
            </button>
          )}

          {/* Notifications */}
          <div className="notifications-wrapper">
            <button 
              className="nav-action-btn"
              onClick={() => setNotificationsOpen(!notificationsOpen)}
            >
              üîî
              {notifications.length > 0 && (
                <span className="notification-badge">{notifications.length}</span>
              )}
            </button>
            
            {notificationsOpen && (
              <div className="notifications-dropdown">
                <div className="dropdown-header">
                  <h3>Notifications</h3>
                  <button onClick={() => setNotificationsOpen(false)}>‚úï</button>
                </div>
                {notifications.length > 0 ? (
                  <div className="notifications-list">
                    {notifications.map((notif, idx) => (
                      <div key={idx} className="notification-item">
                        <span className="notif-icon">{notif.icon || 'üì¢'}</span>
                        <div className="notif-content">
                          <div className="notif-message">{notif.message}</div>
                          <div className="notif-time">{notif.time || 'Just now'}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="no-notifications">No new notifications</p>
                )}
              </div>
            )}
          </div>

          {/* Profile */}
          <div className="profile-wrapper">
            <button 
              className="profile-btn"
              onClick={() => setProfileMenuOpen(!profileMenuOpen)}
            >
              <div className="profile-avatar">
                {quickStats.userName?.charAt(0) || 'U'}
              </div>
            </button>

            {profileMenuOpen && (
              <div className="profile-dropdown">
                <div className="profile-header">
                  <div className="profile-avatar-large">
                    {quickStats.userName?.charAt(0) || 'U'}
                  </div>
                  <div className="profile-info">
                    <strong>{quickStats.userName || 'User'}</strong>
                    <span className="profile-email">{quickStats.email || 'user@example.com'}</span>
                  </div>
                </div>
                
                <div className="profile-stats">
                  <div className="profile-stat">
                    <span className="stat-label">Level</span>
                    <span className="stat-value">{quickStats.level || 1}</span>
                  </div>
                  <div className="profile-stat">
                    <span className="stat-label">Points</span>
                    <span className="stat-value">{quickStats.totalPoints || 0}</span>
                  </div>
                  <div className="profile-stat">
                    <span className="stat-label">Books</span>
                    <span className="stat-value">{quickStats.booksRead || 0}</span>
                  </div>
                </div>
                
                <div className="profile-actions">
                  <button onClick={onProfile} className="profile-action">
                    <span>üë§</span>
                    <span>Profile</span>
                  </button>
                  <button onClick={onSettings} className="profile-action">
                    <span>‚öôÔ∏è</span>
                    <span>Settings</span>
                  </button>
                  <button className="profile-action">
                    <span>üìà</span>
                    <span>Activity</span>
                  </button>
                  <div className="profile-divider"></div>
                  <button className="profile-action logout">
                    <span>üö™</span>
                    <span>Sign Out</span>
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </header>
  );
};

// ===============================================
// BATCH OPERATIONS BAR COMPONENT
// ===============================================
const BatchOperationsBar = ({ 
  selectedCount, 
  onCancel, 
  onSelectAll, 
  onDelete, 
  onAddToCollection,
  onExport,
  onMarkAsRead,
  isAllSelected = false
}) => {
  return (
    <div className="batch-operations-bar">
      <div className="batch-info">
        <span className="batch-count">{selectedCount} selected</span>
        <button onClick={onSelectAll} className="batch-select-all">
          {isAllSelected ? 'Deselect All' : 'Select All'}
        </button>
      </div>
      
      <div className="batch-actions">
        <button onClick={onMarkAsRead} className="batch-action">
          ‚úì Mark as Read
        </button>
        <button onClick={onAddToCollection} className="batch-action">
          üìÅ Add to Collection
        </button>
        <button onClick={onExport} className="batch-action">
          üíæ Export
        </button>
        <button onClick={onDelete} className="batch-action batch-delete">
          üóëÔ∏è Delete
        </button>
      </div>
      
      <button onClick={onCancel} className="batch-cancel">
        ‚úï Cancel
      </button>
    </div>
  );
};

// ===============================================
// FILTER BAR COMPONENT
// ===============================================
const FilterBar = ({ 
  filters, 
  onFilterChange, 
  availableGenres = [],
  availableAuthors = [],
  viewMode,
  onViewModeChange,
  sortBy,
  onSortChange
}) => {
  const [showFilters, setShowFilters] = useState(false);

  const sortOptions = [
    { value: 'title', label: 'Title A-Z' },
    { value: 'author', label: 'Author A-Z' },
    { value: 'recent', label: 'Recently Added' },
    { value: 'progress', label: 'Reading Progress' },
    { value: 'rating', label: 'Rating' }
  ];

  return (
    <div className="filter-bar">
      <div className="filter-controls">
        <button 
          className="filter-toggle"
          onClick={() => setShowFilters(!showFilters)}
        >
          üîΩ Filters {filters.genres?.length > 0 && `(${filters.genres.length})`}
        </button>
        
        <select 
          value={sortBy} 
          onChange={(e) => onSortChange(e.target.value)}
          className="sort-select"
        >
          {sortOptions.map(opt => (
            <option key={opt.value} value={opt.value}>
              Sort: {opt.label}
            </option>
          ))}
        </select>
        
        <div className="view-mode-toggle">
          <button 
            className={viewMode === 'grid' ? 'active' : ''}
            onClick={() => onViewModeChange('grid')}
          >
            ‚öè Grid
          </button>
          <button 
            className={viewMode === 'list' ? 'active' : ''}
            onClick={() => onViewModeChange('list')}
          >
            ‚ò∞ List
          </button>
        </div>
      </div>
      
      {showFilters && (
        <div className="filter-options">
          <div className="filter-group">
            <label>Genres</label>
            <div className="filter-chips">
              {availableGenres.map(genre => (
                <MD3Chip
                  key={genre}
                  label={genre}
                  selected={filters.genres?.includes(genre)}
                  onClick={() => {
                    const newGenres = filters.genres?.includes(genre)
                      ? filters.genres.filter(g => g !== genre)
                      : [...(filters.genres || []), genre];
                    onFilterChange({ ...filters, genres: newGenres });
                  }}
                />
              ))}
            </div>
          </div>
          
          <div className="filter-group">
            <label>Reading Status</label>
            <div className="filter-chips">
              <MD3Chip
                label="Reading"
                selected={filters.status === 'reading'}
                onClick={() => onFilterChange({ ...filters, status: 'reading' })}
              />
              <MD3Chip
                label="Completed"
                selected={filters.status === 'completed'}
                onClick={() => onFilterChange({ ...filters, status: 'completed' })}
              />
              <MD3Chip
                label="To Read"
                selected={filters.status === 'to-read'}
                onClick={() => onFilterChange({ ...filters, status: 'to-read' })}
              />
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ===============================================
// MAIN ENHANCED BOOK LIBRARY APP COMPONENT
// ===============================================
const EnhancedBookLibraryApp = ({ 
  books = [],
  onBookUpdate,
  user,
  analytics = {},
  className = ''
}) => {
  // Core State
  const [currentPage, setCurrentPage] = useState('library');
  const [searchQuery, setSearchQuery] = useState('');
  const [filters, setFilters] = useState({ genres: [], status: null });
  const [sortBy, setSortBy] = useState('title');
  const [viewMode, setViewMode] = useState('grid');
  const [settingsOpen, setSettingsOpen] = useState(false);

  // Batch Operations State
  const [batchMode, setBatchMode] = useState(false);
  const [selectedBooks, setSelectedBooks] = useState([]);
  const [batchUpdating, setBatchUpdating] = useState(false);

  // Loading and Error State
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  // Contexts
  const { trackAction } = useGamification();
  const { showSnackbar } = useSnackbar();

  // Load settings on mount
  useEffect(() => {
    const savedSettings = localStorage.getItem('appSettings');
    if (savedSettings) {
      const settings = JSON.parse(savedSettings);
      // Apply settings like dark mode, etc.
      if (settings.darkMode) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    }
  }, []);

  // Quick stats for header
  const quickStats = useMemo(() => ({
    userName: user?.name || 'Reader',
    email: user?.email,
    level: user?.level || 1,
    totalPoints: user?.points || 0,
    booksRead: books.filter(b => b.status === 'completed').length,
    currentlyReading: books.filter(b => b.isReading).length,
    totalBooks: books.length
  }), [user, books]);

  // Get available genres and authors for filters
  const availableGenres = useMemo(() => {
    const genres = new Set();
    books.forEach(book => {
      book.genres?.forEach(genre => genres.add(genre));
    });
    return Array.from(genres);
  }, [books]);

  // Filter and sort books
  const filteredAndSortedBooks = useMemo(() => {
    let filtered = [...books];

    // Filter by search query
    if (searchQuery) {
      filtered = filtered.filter(book => 
        book.title?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        book.author?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        book.isbn?.includes(searchQuery)
      );
    }

    // Filter by genres
    if (filters.genres?.length > 0) {
      filtered = filtered.filter(book => 
        filters.genres.some(genre => book.genres?.includes(genre))
      );
    }

    // Filter by status
    if (filters.status) {
      filtered = filtered.filter(book => book.status === filters.status);
    }

    // Sort
    filtered.sort((a, b) => {
      switch (sortBy) {
        case 'title':
          return (a.title || '').localeCompare(b.title || '');
        case 'author':
          return (a.author || '').localeCompare(b.author || '');
        case 'recent':
          return (b.addedDate || 0) - (a.addedDate || 0);
        case 'progress':
          return (b.progress || 0) - (a.progress || 0);
        case 'rating':
          return (b.rating || 0) - (a.rating || 0);
        default:
          return 0;
      }
    });

    return filtered;
  }, [books, searchQuery, filters, sortBy]);

  // Handle book actions
  const handleBookRead = useCallback(async (book) => {
    console.log('Opening book:', book.title);
    try {
      await trackAction('book_opened', { bookId: book.id, bookTitle: book.title });
      onBookUpdate?.('read', book);
      showSnackbar({ message: `Opening "${book.title}"`, variant: 'info' });
    } catch (error) {
      console.error('Error opening book:', error);
      showSnackbar({ message: 'Failed to open book', variant: 'error' });
    }
  }, [trackAction, onBookUpdate, showSnackbar]);

  const handleBookEdit = useCallback((book) => {
    console.log('Editing book:', book.title);
    onBookUpdate?.('edit', book);
  }, [onBookUpdate]);

  const handleBookDelete = useCallback(async (book) => {
    console.log('Deleting book:', book.title);
    if (window.confirm(`Are you sure you want to delete "${book.title}"?`)) {
      try {
        onBookUpdate?.('delete', book);
        showSnackbar({ message: `"${book.title}" deleted`, variant: 'success' });
      } catch (error) {
        console.error('Error deleting book:', error);
        showSnackbar({ message: 'Failed to delete book', variant: 'error' });
      }
    }
  }, [onBookUpdate, showSnackbar]);

  const handleStartReading = useCallback(async (book) => {
    console.log('Starting to read:', book.title);
    try {
      await trackAction('start_reading', { bookId: book.id, bookTitle: book.title });
      onBookUpdate?.('startReading', book);
      showSnackbar({ message: `Started reading "${book.title}"`, variant: 'success' });
    } catch (error) {
      console.error('Error starting book:', error);
      showSnackbar({ message: 'Failed to start reading', variant: 'error' });
    }
  }, [trackAction, onBookUpdate, showSnackbar]);

  const handleStopReading = useCallback(async (book) => {
    console.log('Stopping reading:', book.title);
    try {
      await trackAction('stop_reading', { bookId: book.id, bookTitle: book.title });
      onBookUpdate?.('stopReading', book);
      showSnackbar({ message: `Stopped reading "${book.title}"`, variant: 'info' });
    } catch (error) {
      console.error('Error stopping book:', error);
      showSnackbar({ message: 'Failed to stop reading', variant: 'error' });
    }
  }, [trackAction, onBookUpdate, showSnackbar]);

  const handleMenuAction = useCallback((action, book) => {
    console.log('Menu action:', action, 'for book:', book.title);
    
    switch (action) {
      case 'share':
        // Share functionality
        if (navigator.share) {
          navigator.share({
            title: book.title,
            text: `Check out "${book.title}" by ${book.author}`,
            url: window.location.href
          });
        }
        break;
        
      case 'find-cover':
        onBookUpdate?.('findCover', book);
        break;
        
      case 'add-to-collection':
        onBookUpdate?.('addToCollection', book);
        break;
        
      default:
        onBookUpdate?.(action, book);
    }
  }, [onBookUpdate]);

  // Batch operations
  const handleBatchDelete = useCallback(async () => {
    if (window.confirm(`Delete ${selectedBooks.length} books?`)) {
      setBatchUpdating(true);
      try {
        for (const bookId of selectedBooks) {
          await onBookUpdate?.('delete', books.find(b => b.id === bookId));
        }
        showSnackbar({ 
          message: `Deleted ${selectedBooks.length} books`, 
          variant: 'success' 
        });
        setSelectedBooks([]);
        setBatchMode(false);
      } catch (error) {
        console.error('Error deleting books:', error);
        showSnackbar({ message: 'Failed to delete books', variant: 'error' });
      } finally {
        setBatchUpdating(false);
      }
    }
  }, [selectedBooks, books, onBookUpdate, showSnackbar]);

  const handleSelectAll = useCallback(() => {
    if (selectedBooks.length === filteredAndSortedBooks.length) {
      setSelectedBooks([]);
    } else {
      setSelectedBooks(filteredAndSortedBooks.map(b => b.id));
    }
  }, [selectedBooks, filteredAndSortedBooks]);

  // Render page content based on current page
  const renderPageContent = () => {
    switch (currentPage) {
      case 'library':
        return (
          <div className="library-page">
            {/* Search and Filter Bar */}
            <div className="library-controls">
              <MD3TextField
                placeholder="Search books..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                leadingIcon="üîç"
                className="search-field"
              />
              
              <FilterBar
                filters={filters}
                onFilterChange={setFilters}
                availableGenres={availableGenres}
                viewMode={viewMode}
                onViewModeChange={setViewMode}
                sortBy={sortBy}
                onSortChange={setSortBy}
              />
              
              <div className="control-buttons">
                <MD3Button
                  variant="outlined"
                  onClick={() => setBatchMode(!batchMode)}
                >
                  {batchMode ? '‚úï Cancel' : '‚òë Select'}
                </MD3Button>
              </div>
            </div>

            {/* Batch Operations Bar */}
            {batchMode && (
              <BatchOperationsBar
                selectedCount={selectedBooks.length}
                onCancel={() => {
                  setBatchMode(false);
                  setSelectedBooks([]);
                }}
                onSelectAll={handleSelectAll}
                onDelete={handleBatchDelete}
                onAddToCollection={() => console.log('Add to collection')}
                onExport={() => console.log('Export books')}
                onMarkAsRead={() => console.log('Mark as read')}
                isAllSelected={selectedBooks.length === filteredAndSortedBooks.length}
              />
            )}

            {/* Books Grid/List */}
            <div className={`books-container ${viewMode}`}>
              {filteredAndSortedBooks.length > 0 ? (
                filteredAndSortedBooks.map(book => (
                  <div 
                    key={book.id}
                    className={batchMode && selectedBooks.includes(book.id) ? 'selected' : ''}
                    onClick={batchMode ? () => {
                      setSelectedBooks(prev => 
                        prev.includes(book.id) 
                          ? prev.filter(id => id !== book.id)
                          : [...prev, book.id]
                      );
                    } : undefined}
                  >
                    <EnhancedBookCard
                      book={book}
                      viewMode={viewMode}
                      onRead={handleBookRead}
                      onStartReading={handleStartReading}
                      onStopReading={handleStopReading}
                      onEdit={handleBookEdit}
                      onDelete={handleBookDelete}
                      onMenuAction={handleMenuAction}
                    />
                  </div>
                ))
              ) : (
                <div className="empty-state">
                  <span className="empty-icon">üìö</span>
                  <h3>No books found</h3>
                  <p>Try adjusting your search or add some books to your library</p>
                  <MD3Button variant="filled" onClick={() => onBookUpdate?.('add')}>
                    Add Books
                  </MD3Button>
                </div>
              )}
            </div>
          </div>
        );

      case 'reading':
        const readingBooks = books.filter(b => b.isReading);
        return (
          <div className="reading-page">
            <h2>Currently Reading ({readingBooks.length})</h2>
            <div className="books-container grid">
              {readingBooks.length > 0 ? (
                readingBooks.map(book => (
                  <EnhancedBookCard
                    key={book.id}
                    book={book}
                    viewMode="grid"
                    onRead={handleBookRead}
                    onStartReading={handleStartReading}
                    onStopReading={handleStopReading}
                    onEdit={handleBookEdit}
                    onDelete={handleBookDelete}
                    onMenuAction={handleMenuAction}
                  />
                ))
              ) : (
                <div className="empty-state">
                  <span className="empty-icon">üìñ</span>
                  <h3>No books in progress</h3>
                  <p>Start reading a book from your library</p>
                  <MD3Button variant="filled" onClick={() => setCurrentPage('library')}>
                    Browse Library
                  </MD3Button>
                </div>
              )}
            </div>
          </div>
        );

      case 'gamification':
        return <GamificationDashboard />;

      case 'collections':
        return (
          <div className="collections-page">
            <h2>Collections</h2>
            <div className="collections-grid">
              <div className="collection-card add-new">
                <span className="collection-icon">‚ûï</span>
                <span>Create Collection</span>
              </div>
              <div className="collection-card">
                <span className="collection-icon">‚≠ê</span>
                <span>Favorites</span>
                <small>0 books</small>
              </div>
              <div className="collection-card">
                <span className="collection-icon">üìö</span>
                <span>To Read</span>
                <small>0 books</small>
              </div>
            </div>
          </div>
        );

      case 'stats':
        const stats = {
          totalBooks: books.length,
          booksRead: books.filter(b => b.status === 'completed').length,
          currentlyReading: books.filter(b => b.isReading).length,
          totalPages: books.reduce((sum, b) => sum + (b.pages || 0), 0),
          averageRating: books.filter(b => b.rating).reduce((sum, b) => sum + b.rating, 0) / books.filter(b => b.rating).length || 0,
          genres: availableGenres.length
        };

        return (
          <div className="stats-page">
            <h2>Reading Statistics</h2>
            <div className="stats-grid">
              <MD3Card className="stat-card">
                <span className="stat-icon">üìö</span>
                <h3>Total Books</h3>
                <div className="stat-value">{stats.totalBooks}</div>
              </MD3Card>
              <MD3Card className="stat-card">
                <span className="stat-icon">‚úÖ</span>
                <h3>Books Read</h3>
                <div className="stat-value">{stats.booksRead}</div>
              </MD3Card>
              <MD3Card className="stat-card">
                <span className="stat-icon">üìñ</span>
                <h3>Currently Reading</h3>
                <div className="stat-value">{stats.currentlyReading}</div>
              </MD3Card>
              <MD3Card className="stat-card">
                <span className="stat-icon">üìÑ</span>
                <h3>Total Pages</h3>
                <div className="stat-value">{stats.totalPages.toLocaleString()}</div>
              </MD3Card>
              <MD3Card className="stat-card">
                <span className="stat-icon">‚≠ê</span>
                <h3>Average Rating</h3>
                <div className="stat-value">{stats.averageRating.toFixed(1)}</div>
              </MD3Card>
              <MD3Card className="stat-card">
                <span className="stat-icon">üè∑Ô∏è</span>
                <h3>Genres</h3>
                <div className="stat-value">{stats.genres}</div>
              </MD3Card>
            </div>
            
            <div className="reading-insights">
              <h3>Reading Insights</h3>
              <div className="insight-cards">
                <div className="insight-card">
                  <h4>Most Read Genre</h4>
                  <p>Fiction</p>
                </div>
                <div className="insight-card">
                  <h4>Reading Streak</h4>
                  <p>0 days</p>
                </div>
                <div className="insight-card">
                  <h4>Books This Month</h4>
                  <p>0</p>
                </div>
              </div>
            </div>
          </div>
        );

      default:
        return null;
    }
  };

  return (
    <div className={`enhanced-book-library-app ${className}`}>
      {/* Navigation Header */}
      <NavigationHeader
        currentPage={currentPage}
        onNavigate={setCurrentPage}
        onSearch={(query) => setSearchQuery(query)}
        onSettings={() => setSettingsOpen(true)}
        onProfile={() => console.log('Profile clicked')}
        onNotifications={() => console.log('Notifications clicked')}
        notifications={[
          // Example notifications
          // { icon: 'üéâ', message: 'Achievement unlocked!', time: '2 min ago' },
          // { icon: 'üìö', message: 'New book recommendation', time: '1 hour ago' }
        ]}
        quickStats={quickStats}
      />

      {/* Main Content */}
      <main className="main-content">
        {/* Enhanced Welcome Dashboard - Only show on library page */}
        {currentPage === 'library' && books.length > 0 && (
          <EnhancedWelcomeComponent 
            books={books} 
            onNavigate={setCurrentPage}
            analytics={analytics}
          />
        )}

        {/* Loading State */}
        {loading && (
          <div className="loading-overlay">
            <CircularProgress />
            <p>Loading...</p>
          </div>
        )}

        {/* Error State */}
        {error && (
          <div className="error-banner">
            <span>‚ö†Ô∏è {error}</span>
            <button onClick={() => setError(null)}>‚úï</button>
          </div>
        )}

        {/* Page Content */}
        {renderPageContent()}
      </main>

      {/* Settings Dialog */}
      <SettingsDialog 
        open={settingsOpen} 
        onClose={() => setSettingsOpen(false)} 
      />

      {/* Floating Action Button */}
      <MD3BookLibraryFab
        onAddBook={() => onBookUpdate?.('add')}
        onImportBooks={() => onBookUpdate?.('import')}
        onScan={() => onBookUpdate?.('scan')}
        onUpload={() => onBookUpdate?.('upload')}
        disabled={loading || batchMode}
      />
    </div>
  );
};

export default EnhancedBookLibraryApp;