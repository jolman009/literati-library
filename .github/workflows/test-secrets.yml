# Test Repository Secrets Configuration
# Run this workflow to verify your secrets are configured correctly

name: Test Repository Secrets

on:
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Environment to test'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  test-secrets:
    name: ðŸ§ª Test Secrets Configuration
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Verify Required Secrets
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          PROD_SUPABASE_URL: ${{ secrets.PRODUCTION_SUPABASE_URL }}
          PROD_SUPABASE_KEY: ${{ secrets.PRODUCTION_SUPABASE_ANON_KEY }}
          STAGING_SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          STAGING_SUPABASE_KEY: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}
        run: |
          echo "ðŸ” Testing repository secrets configuration..."
          echo ""

          # Test Vercel secrets
          if [ -n "$VERCEL_TOKEN" ]; then
            echo "âœ… VERCEL_TOKEN: Configured (${#VERCEL_TOKEN} characters)"
          else
            echo "âŒ VERCEL_TOKEN: Missing"
            exit 1
          fi

          if [ -n "$VERCEL_ORG_ID" ]; then
            echo "âœ… VERCEL_ORG_ID: Configured ($VERCEL_ORG_ID)"
          else
            echo "âŒ VERCEL_ORG_ID: Missing"
            exit 1
          fi

          if [ -n "$VERCEL_PROJECT_ID" ]; then
            echo "âœ… VERCEL_PROJECT_ID: Configured (${VERCEL_PROJECT_ID:0:8}...)"
          else
            echo "âŒ VERCEL_PROJECT_ID: Missing"
            exit 1
          fi

          # Test Supabase secrets
          if [ -n "$PROD_SUPABASE_URL" ]; then
            echo "âœ… PRODUCTION_SUPABASE_URL: Configured ($PROD_SUPABASE_URL)"
          else
            echo "âŒ PRODUCTION_SUPABASE_URL: Missing"
            exit 1
          fi

          if [ -n "$PROD_SUPABASE_KEY" ]; then
            echo "âœ… PRODUCTION_SUPABASE_ANON_KEY: Configured (${#PROD_SUPABASE_KEY} characters)"
          else
            echo "âŒ PRODUCTION_SUPABASE_ANON_KEY: Missing"
            exit 1
          fi

          # Optional staging secrets
          if [ -n "$STAGING_SUPABASE_URL" ]; then
            echo "âœ… STAGING_SUPABASE_URL: Configured ($STAGING_SUPABASE_URL)"
          else
            echo "âš ï¸ STAGING_SUPABASE_URL: Not configured (optional)"
          fi

          if [ -n "$STAGING_SUPABASE_KEY" ]; then
            echo "âœ… STAGING_SUPABASE_ANON_KEY: Configured (${#STAGING_SUPABASE_KEY} characters)"
          else
            echo "âš ï¸ STAGING_SUPABASE_ANON_KEY: Not configured (optional)"
          fi

          echo ""
          echo "ðŸŽ‰ All required secrets are configured!"

      - name: ðŸ”§ Test Build with Secrets
        working-directory: ./client2
        env:
          VITE_API_BASE_URL: https://library-server-m6gr.onrender.com
          VITE_AI_SERVICE_URL: https://literati-ai-production.onrender.com
          VITE_SUPABASE_URL: ${{ secrets.PRODUCTION_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.PRODUCTION_SUPABASE_ANON_KEY }}
          VITE_ENABLE_SERVICE_WORKER: true
          VITE_APP_ENV: ${{ github.event.inputs.test_environment }}
        run: |
          echo "ðŸ—ï¸ Testing build with configured secrets..."

          # Install dependencies
          npm install -g pnpm
          pnpm install --frozen-lockfile

          # Test production build
          pnpm run build:production

          echo "âœ… Build completed successfully with secrets!"

      - name: ðŸ“Š Success Report
        run: |
          echo "# ðŸŽ‰ Secrets Configuration Test - SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required repository secrets are properly configured!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Verified Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "- VERCEL_TOKEN âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- VERCEL_ORG_ID âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- VERCEL_PROJECT_ID âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- PRODUCTION_SUPABASE_URL âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- PRODUCTION_SUPABASE_ANON_KEY âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Ready for Deployment!" >> $GITHUB_STEP_SUMMARY
          echo "Your CI/CD pipeline is now configured and ready to deploy." >> $GITHUB_STEP_SUMMARY