name: Auto-Alias Production Domain

on:
  # Trigger after successful deployment
  deployment_status:

jobs:
  update-domain-aliases:
    if: github.event.deployment_status.state == 'success' && github.event.deployment_status.environment == 'Production'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Get Latest Deployment URL
        id: deployment
        run: |
          # Extract deployment URL from the deployment status
          DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT

      - name: Update Custom Domain Aliases
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # Set alias for literati.pro domains
          vercel alias set ${{ steps.deployment.outputs.deployment_url }} literati.pro --token=$VERCEL_TOKEN || echo "âš ï¸ Could not alias literati.pro (permission issue)"
          vercel alias set ${{ steps.deployment.outputs.deployment_url }} www.literati.pro --token=$VERCEL_TOKEN || echo "âš ï¸ Could not alias www.literati.pro (permission issue)"

          # Set alias for shelfquest.org domains
          vercel alias set ${{ steps.deployment.outputs.deployment_url }} shelfquest.org --token=$VERCEL_TOKEN
          vercel alias set ${{ steps.deployment.outputs.deployment_url }} www.shelfquest.org --token=$VERCEL_TOKEN

          echo "âœ… Domain aliases updated successfully"
          echo "ğŸŒ literati.pro â†’ ${{ steps.deployment.outputs.deployment_url }}"
          echo "ğŸŒ www.literati.pro â†’ ${{ steps.deployment.outputs.deployment_url }}"
          echo "ğŸŒ shelfquest.org â†’ ${{ steps.deployment.outputs.deployment_url }}"
          echo "ğŸŒ www.shelfquest.org â†’ ${{ steps.deployment.outputs.deployment_url }}"

      - name: Verify Domain Update
        run: |
          echo "ğŸ” Verifying domain routing..."
          sleep 10  # Wait for DNS propagation

          # Check if domains are responding (may get 401 due to deployment protection)
          curl -I https://literati.pro || echo "literati.pro routing updated (may show 401 due to deployment protection)"
          curl -I https://www.literati.pro || echo "www.literati.pro routing updated"
          curl -I https://shelfquest.org || echo "shelfquest.org routing updated (may show 401 due to deployment protection)"
          curl -I https://www.shelfquest.org || echo "www.shelfquest.org routing updated"